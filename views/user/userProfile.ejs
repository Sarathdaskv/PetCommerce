<%- include('../layout/userHeader.ejs')%>
    <div style="background: #eeeeee;">
        <div class="container-fluid user-order pb-5" style="padding-top: 30px;">
            <div class="row px-xl-5 userProfile">
                <div class="col-lg-3">
                    <div class="profileSideBar d-flex mb-3">
                        <form action="" method="post" id="photoForm" enctype="multipart/form-data">
                            <div>
                                <input type="text" name="userName" value="<%= userDetails.userName %>"
                                    style="display:none">
                                <input type="file" id="imgupload" style="display:none" name="photo"
                                    onchange="uploadPhoto(event)" />
                                <a style="border: 0; background: transparent;" id="OpenImgUpload"><img
                                        src="/img/users/<%=userDetails.photo %>" alt="" name="currentPhoto">
                                </a>
                            </div>
                        </form>

                        <div class="username">
                            <p class="mb-0">Hello Welcome,</p>
                            <span>
                                <%= userDetails.userName %>
                            </span>
                        </div>
                    </div>

                    <div class="profileSideBar">
                        <div class="row">
                            <div>
                                <div class="menu d-flex">
                                    <!-- <span class="material-symbols-outlined">
                                    folder
                                </span> -->
                                    <a class="title">My Orders</a>
                                </div>
                            </div>
                            <div>
                                <div class="menu d-flex">
                                    <!-- <span class="material-symbols-outlined">
                                    person
                                </span> -->
                                    <a class="title">Account Settings</a>
                                </div>
                                <div class="submenus">
                                    <a href="#" class="btn_submenus show" onclick="showContents(this, 'content_1')">
                                        <div class="subTitle">Profile Information</div>
                                    </a>
                                    <a href="#" class="btn_submenus"
                                        onclick="showContents(this, 'content_2') ,showAddress()">
                                        <div class="subTitle">Manage Address</div>
                                    </a>
                                    <a href="#" class="btn_submenus" onclick="showContents(this, 'content_3')">
                                        <div class="subTitle">Change Password</div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--Cropping Modal -->
                <div class="modal fade" id="modal0" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalLabel">Crop image</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true" style="color: black;font-weight: bolder;">x</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="img-container">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <!--  default image where we will set the src via jquery-->
                                            <img id="imageToCrop">
                                        </div>
                                        <div class="col-md-4">
                                            <div class="preview"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="crop">Crop</button>
                            </div>
                        </div>
                    </div>
                </div>







                <div class="col-lg-9">
                    <div class="sidebarDetails tabContents">

                        <!-- ()()()()()()()()()()()()() 1st TAB Content Started ()()()()()()()()()()()()() -->
                        <div class="tab_subtitleContent show mb-4" id="content_1">

                            <!-------------------------Profile Information Started-------------------------->
                            <div class="d-flex" style="align-items: center;">
                                <span class="title">Profile Information</span>
                                <a href="#" id="proEditBtn" class="edit" onclick="editProfile()">Edit</a>
                                <a href="#" id="proCaneclBtn" class="edit" onclick="cancelBtn()"
                                    style="display: none;">Cancel</a>
                            </div>
                            <form action="" id="profileUpdateForm">
                                <div class="pb-2" style="width: 100%;">
                                    <div style="width: 100%; padding-right: 12px;" id="profileData">
                                        <div class="d-flex" style="margin-bottom: 10px;">
                                            <div class="field" style="width: 270px; padding-right: 12px;">
                                                <label for="" class="form-label">Full Name</label>
                                                <input disabled type="text" class="form-control" id="name" name="name"
                                                    style="width: 100%;" value="<%= userDetails.name %>" required>
                                            </div>
                                            <!-- <div class="field" style="width: 270px; padding-right: 12px;">
                                            <label for="" class="form-label">Last Name</label>
                                            <input disabled type="text" class="form-control" id="last_Name" name="last_Name"
                                                style="width: 100%;" value="<%= userDetails.last_Name %>">
                                        </div> -->
                                            <div id="proBtn" style="display: none;">
                                                <label for=""></label>
                                                <input type="submit" class="btn btn-primary" id="" name=""
                                                    style="width: 100%;" value="SAVE">
                                            </div>
                                        </div>
                                        <div class="d-flex" style="margin-bottom: 10px;">
                                            <div class="field" style="width: 270px; padding-right: 12px;">
                                                <label for="" class="form-label">User Name</label>
                                                <input disabled type="text" class="form-control" id="userName"
                                                    name="userName" style="width: 100%;"
                                                    value="<%= userDetails.userName %>" required>
                                            </div>
                                            <!-- <div class="field" style="width: 270px; padding-right: 12px;">
                                            <label for="" class="form-label">Your Gender</label>
                                            <div>
                                                <input class="form-check-input me-3" type="radio"
                                                    name="gender" id="flexRadioDefault1"
                                                    value="Male">Male
                                                <input class="form-check-input ms-4 me-3" type="radio"
                                                    name="gender" id="flexRadioDefault1"
                                                    value="Female">Female
                                            </div>
                                        </div> -->
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <!-------------------------Profile Information Ended-------------------------->

                            <!-------------------------Email & Mobile Information Started-------------------------->
                            <div class="d-flex" style="align-items: center;">
                                <span class="title">Email & Mobile Information</span>
                                <a href="#" id="emailEditBtn" class="edit" onclick="emailEdit()">Edit</a>
                                <a href="#" id="emailCancelBtn" class="edit" style="display: none;"
                                    onclick="emailCancel()">Cancel</a>
                            </div>
                            <form action="" id="emailUpdateForm">
                                <div class="pb-2" style="width: 100%;">
                                    <div style="width: 100%; padding-right: 12px;">
                                        <div class="d-flex" style="margin-bottom: 10px;">
                                            <div class="field" style="width: 270px; padding-right: 12px;">
                                                <label for="" class="form-label">Mobile No.</label>
                                                <input disabled type="text" class="form-control" id="phoneNumber"
                                                    name="phoneNumber" style="width: 100%;"
                                                    value="<%= userDetails.phoneNumber %>" pattern="[0-9]{10}" required>
                                            </div>
                                            <div class="field" style="width: 270px; padding-right: 12px;">
                                                <label for="" class="form-label">Email</label>
                                                <input disabled type="text" class="form-control" id="email" name="email"
                                                    style="width: 100%;" value="<%= userDetails.email %> " required>
                                            </div>
                                            <div>
                                                <label for=""></label>
                                                <input type="submit" class="btn btn-primary" id="emailBtn" name=""
                                                    style="width: 100%; display: none;" value="SAVE">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <!-------------------------Email & Mobile Information Ended-------------------------->

                        </div>
                        <!-- ()()()()()()()()()()()()() 1st TAB Content Ended ()()()()()()()()()()()()() -->

                        <!-- ()()()()()()()()()()()()() 2nd TAB Content Started ()()()()()()()()()()()()() -->
                        <div class="tab_subtitleContent mb-4" id="content_2">
                            <!-------------------------Manage Address Started-------------------------->
                            <span class="title">Manage Address</span>
                            <div class="mt-3">
                                <a href="/addressPage" class="btn"
                                    style="width: 100%; text-align: left; border: 1px solid #e0e0e0; color: #2874f0;"> +
                                    Add
                                    A New Address</a>
                            </div>
                            <div id="userAddressList"></div>
                            <!-------------------------Manage Address Ended-------------------------->
                        </div>
                        <!-- ()()()()()()()()()()()()() 2nd TAB Content Ended ()()()()()()()()()()()()() -->

                        <!-- ()()()()()()()()()()()()() 3rd TAB Content Started ()()()()()()()()()()()()() -->
                        <div class="tab_subtitleContent" id="content_3">
                            <!-------------------------Change Password Started-------------------------->
                            <span class="title">Change Password</span>
                            <form action="" id="changePassword">
                                <div class="pb-2" style="width: 100%;">
                                    <div style="width: 100%; padding-right: 12px;">
                                        <small id="userProfilePasswordError" style="color: red;"></small>
                                        <div class="d-flex" style="margin-bottom: 10px;">
                                            <div class="field" style="width: 270px; padding-right: 12px;">
                                                <label for="" class="form-label">New Password</label>
                                                <input type="password" class="form-control" id="profilePassword"
                                                    name="profilePassword" style="width: 100%;" required>
                                            </div>
                                            <div class="field" style="width: 270px; padding-right: 12px;">
                                                <label for="" class="form-label">Confirm Password</label>
                                                <input type="password" class="form-control" id="profileCfmPassword"
                                                    name="profileCfmPassword" style="width: 100%;" required>
                                            </div>
                                            <div>
                                                <label for=""></label>
                                                <input type="submit" class="btn btn-primary" id="" name=""
                                                    style="width: 100%;" value="SAVE">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            <!-------------------------Change Password Ended-------------------------->
                        </div>
                        <!-- ()()()()()()()()()()()()() 3rd TAB Content Ended ()()()()()()()()()()()()() -->
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>



    <script>

        var bsmodal = $('#modal0');
        var image = document.getElementById('imageToCrop');
        var cropper, reader, file;

        // let selectedPhoto = document.getElementById('imgupload')

        function showContents(activeTab, contentsID) {
            var tabs = document.querySelectorAll('.btn_submenus');
            var contents = document.querySelectorAll('.tab_subtitleContent');

            var i = 0;
            while (i < tabs.length) {
                tabs[i].classList.remove('show');
                contents[i].classList.remove('show');
                i++;
            }
            activeTab.classList.add('show');
            document.getElementById(contentsID).classList.add('show');
        }



        function showAddress() {
            const address = document.getElementById('userAddressList')
            fetch('/userProfile/address', {
                method: 'get',
                headers: { 'Content-Type': 'application/json' }
            }).then(res => res.json()).then(data => {
                // console.log(data.addressList[0].addresses);
                let datas = data.addressList[0].addresses
                let addressess =
                    ``
                for (var i = 0; i < datas.length; i++) {
                    addressess +=
                        `<div style="border: 1px solid #e0e0e0; margin-top: 20px; border-radius: 2px 0;">
                                <div style="width: 100%; overflow: hidden; padding: 20px;">
                                    <p style="line-height: 1.5">
                                        <span style="font-weight: 600; font-size: 14px;">${datas[i].building}</span>
                                        <span
                                            style="font-weight: 600; padding-right: 15px; font-size: 14px;">${datas[i].mobileNumber}</span>
                                            <a href="/userProfile/addressEditPage?addressID=${datas[i]._id}" id="emailEditBtn" class="edit">Edit</a>
                                            <a onclick="addressDelete('${datas[i]._id}')" href="#" id="emailEditBtn" class="edit">Delete</a>
                                    </p>
                                    <span style="margin-top: 10px; width: 100%; display: block; font-size: 14px;">${datas[i].address}</span>
                                </div>
                            </div>`
                }
                addressess +=
                    ``
                address.innerHTML = addressess

            }).catch((error) => {
                console.log(error.message);
            })
        }

        function addressDelete(addressID, addressDocID) {
            fetch('/userProfile/addressDelete', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ addressID })
            }).then(() => {
                window.location.reload()
            })
        }


        function uploadPhoto(e) {
          
            var files = e.target.files;

            let done = function (url) {
                image.src = url;
                bsmodal.modal('show');

            };
            if (files && files.length > 0) {
                file = files[0];


                if (URL) {
                    done(URL.createObjectURL(file));
                } else
                    if (FileReader) {
                        reader = new FileReader();
                        reader.onload = function (e) {

                            done(reader.result);
                        };
                        reader.readAsDataURL(file);
                    }
            }

        };
        bsmodal.on('shown.bs.modal', function () {
            console.log("jhgsjhsd")
            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 3,
                preview: '.preview'
            });
        }).on('hidden.bs.modal', function () {
            cropper.destroy();
            cropper = null;
        });

        $("#crop").click(function () {
            canvas = cropper.getCroppedCanvas({
                width: 160,
                height: 160,
            });


            canvas.toBlob(function (blob) {
                var reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function () {

                    let file = new File([blob], "img.jpg", { type: "image/jpeg", lastModified: new Date().getTime() });
                    let container = new DataTransfer();
                    container.items.add(file);
                    $("#imgupload")[0].files = container.files;
                    bsmodal.modal('hide')

                };
            });
            setTimeout(()=>{
                $('#photoForm').submit()
            },500)
           
            
        });

       



        $('#OpenImgUpload').click(function (e) {

            $('#imgupload').trigger('click');
        });


    </script>

    <%- include('../layout/userFooter.ejs')%>